<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum Discussion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .hidden {
            display: none;
        }
        .post {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .post-author {
            font-weight: bold;
        }
        .post-time {
            color: #888;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        input, textarea, button {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        input, textarea {
            width: 100%;
        }
        input.error-field {
            border-color: #dc3545;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .password-requirements {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .password-requirements ul {
            margin: 5px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div id="message-container" class="hidden message"></div>
    
    <!-- Login/Register Forms -->
    <div id="auth-forms">
        <h2>Login</h2>
        <form id="login-form">
            <div class="form-group">
                <input type="text" id="login-username" placeholder="Username" required>
                <div id="login-username-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <input type="password" id="login-password" placeholder="Password" required>
                <div id="login-password-error" class="form-error"></div>
            </div>
            <div id="login-general-error" class="form-error"></div>
            <button type="submit">Login</button>
        </form>
        
        <h2>Register</h2>
        <div class="password-requirements">
            <strong>Password Requirements:</strong>
            <ul>
                <li>At least 8 characters long</li>
                <li>At least one uppercase letter</li>
                <li>At least one lowercase letter</li>
                <li>At least one number</li>
            </ul>
        </div>
        <form id="register-form">
            <div class="form-group">
                <input type="text" id="register-username" placeholder="Username (4-30 characters, letters, numbers, underscores)" required>
                <div id="register-username-error" class="form-error"></div>
            </div>
            <div class="form-group">
                <input type="password" id="register-password" placeholder="Password" required>
                <div id="register-password-error" class="form-error"></div>
            </div>
            <div id="register-general-error" class="form-error"></div>
            <button type="submit">Register</button>
        </form>
    </div>

    <!-- Forum Section (Hidden until logged in) -->
    <div id="forum-section" class="hidden">
        <div id="user-info">
            <p>Welcome, <span id="username-display"></span>! <button id="logout-btn">Logout</button></p>
        </div>
        
        <h2>Discussion Forum</h2>
        
        <div id="post-form">
            <h3>Create New Post</h3>
            <form id="new-post-form">
                <div class="form-group">
                    <input type="text" id="post-title" placeholder="Title" required>
                    <div id="post-title-error" class="form-error"></div>
                </div>
                <div class="form-group">
                    <textarea id="post-content" placeholder="Write your post here..." required></textarea>
                    <div id="post-content-error" class="form-error"></div>
                </div>
                <div id="post-general-error" class="form-error"></div>
                <button type="submit">Post</button>
            </form>
        </div>
        
        <div id="posts-container">
            <h3>Recent Posts</h3>
            <div id="posts-list">
                <!-- Posts will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let lastTimestamp = 0;
        let refreshInterval;
        
        // Reset form errors
        function resetFormErrors(formId) {
            $(`#${formId} .form-error`).hide();
            $(`#${formId} input, #${formId} textarea`).removeClass('error-field');
        }
        
        // Display form error
        function showFormError(elementId, message) {
            $(`#${elementId}`).text(message).show();
            // Add error class to the related input
            const inputId = elementId.replace('-error', '');
            $(`#${inputId}`).addClass('error-field');
        }
        
        // Show message function
        function showMessage(message, isSuccess = true) {
            const messageContainer = $('#message-container');
            messageContainer.removeClass('success error').addClass(isSuccess ? 'success' : 'error');
            messageContainer.text(message).removeClass('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageContainer.addClass('hidden');
            }, 5000);
        }
        
        // Check authentication status
        function checkAuth() {
            $.ajax({
                url: 'check_auth.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        // User is logged in
                        $('#username-display').text(response.data.username);
                        $('#auth-forms').addClass('hidden');
                        $('#forum-section').removeClass('hidden');
                        loadPosts();
                        
                        // Start checking for new posts every 5 seconds
                        refreshInterval = setInterval(checkForNewPosts, 5000);
                    } else {
                        // User is not logged in
                        $('#auth-forms').removeClass('hidden');
                        $('#forum-section').addClass('hidden');
                        
                        // Clear refresh interval if exists
                        if (refreshInterval) {
                            clearInterval(refreshInterval);
                        }
                    }
                }
            });
        }
        
        // Client-side validation functions
        function validateUsername(username, isLogin = false) {
            if (!username) {
                return "Username is required";
            }
            
            if (!isLogin) {
                if (username.length < 4) {
                    return "Username must be at least 4 characters long";
                }
                
                if (username.length > 30) {
                    return "Username cannot exceed 30 characters";
                }
                
                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    return "Username can only contain letters, numbers, and underscores";
                }
            }
            
            return null;
        }
        
        function validatePassword(password, isLogin = false) {
            if (!password) {
                return "Password is required";
            }
            
            if (!isLogin) {
                if (password.length < 8) {
                    return "Password must be at least 8 characters long";
                }
                
                if (!/[A-Z]/.test(password)) {
                    return "Password must contain at least one uppercase letter";
                }
                
                if (!/[a-z]/.test(password)) {
                    return "Password must contain at least one lowercase letter";
                }
                
                if (!/[0-9]/.test(password)) {
                    return "Password must contain at least one number";
                }
            }
            
            return null;
        }
        
        // Register user
        function registerUser(username, password) {
            header('Location: test_register.php');
            return;
            // Reset previous errors
            resetFormErrors('register-form');
            
            // Client-side validation
            const usernameError = validateUsername(username);
            const passwordError = validatePassword(password);
            
            if (usernameError) {
                showFormError('register-username-error', usernameError);
                return;
            }
            
            if (passwordError) {
                showFormError('register-password-error', passwordError);
                return;
            }
            
            $.ajax({
                url: 'register.php',
                type: 'POST',
                data: {
                    username: username,
                    password: password
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message);
                        // Clear form
                        $('#register-username').val('');
                        $('#register-password').val('');
                    } else {
                        // Display specific error message based on the response
                        if (response.message.includes("Username already exists")) {
                            showFormError('register-username-error', response.message);
                        } else if (response.message.includes("Username")) {
                            showFormError('register-username-error', response.message);
                        } else if (response.message.includes("Password")) {
                            showFormError('register-password-error', response.message);
                        } else {
                            showFormError('register-general-error', response.message);
                        }
                    }
                },
                error: function() {
                    showFormError('register-general-error', 'Server error during registration. Please try again later.');
                }
            });
        }
        
        // Login user
        function loginUser(username, password) {
            // Reset previous errors
            resetFormErrors('login-form');
            
            // Client-side validation
            const usernameError = validateUsername(username, true);
            const passwordError = validatePassword(password, true);
            
            if (usernameError) {
                showFormError('login-username-error', usernameError);
                return;
            }
            
            if (passwordError) {
                showFormError('login-password-error', passwordError);
                return;
            }
            
            $.ajax({
                url: 'login.php',
                type: 'POST',
                data: {
                    username: username,
                    password: password
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message);
                        checkAuth(); // Update UI
                    } else {
                        // Display specific error message based on the response
                        if (response.message.includes("Username")) {
                            showFormError('login-username-error', response.message);
                        } else if (response.message.includes("Password") || response.message.includes("password")) {
                            showFormError('login-password-error', response.message);
                        } else {
                            showFormError('login-general-error', response.message);
                        }
                    }
                },
                error: function() {
                    showFormError('login-general-error', 'Server error during login. Please try again later.');
                }
            });
        }
        
        // Logout user
        function logoutUser() {
            $.ajax({
                url: 'logout.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message);
                        checkAuth(); // Update UI
                    }
                },
                error: function() {
                    showMessage('Error during logout', false);
                }
            });
        }
        
        // Create post
        function createPost(title, content) {
            // Reset previous errors
            resetFormErrors('new-post-form');
            
            // Simple validation
            if (!title.trim()) {
                showFormError('post-title-error', 'Title is required');
                return;
            }
            
            if (!content.trim()) {
                showFormError('post-content-error', 'Content is required');
                return;
            }
            
            $.ajax({
                url: 'create_post.php',
                type: 'POST',
                data: {
                    title: title,
                    content: content
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        showMessage(response.message);
                        // Clear form
                        $('#post-title').val('');
                        $('#post-content').val('');
                        // Reload posts
                        loadPosts();
                    } else {
                        if (response.message.includes("Title")) {
                            showFormError('post-title-error', response.message);
                        } else if (response.message.includes("Content")) {
                            showFormError('post-content-error', response.message);
                        } else {
                            showFormError('post-general-error', response.message);
                        }
                    }
                },
                error: function() {
                    showFormError('post-general-error', 'Error creating post. Please try again.');
                }
            });
        }
        
        // Load posts
        function loadPosts() {
            $.ajax({
                url: 'get_posts.php',
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        const posts = response.data.posts;
                        $('#posts-list').empty();
                        
                        if (posts.length === 0) {
                            $('#posts-list').html('<p>No posts yet. Be the first to post!</p>');
                            return;
                        }
                        
                        posts.forEach(post => {
                            const postDate = new Date(post.created_at);
                            const postElement = `
                                <div class="post" data-id="${post.post_id}">
                                    <div class="post-header">
                                        <span class="post-author">${post.username}</span>
                                        <span class="post-time">${postDate.toLocaleString()}</span>
                                    </div>
                                    <h3>${post.title}</h3>
                                    <div class="post-content">${post.content}</div>
                                </div>
                            `;
                            $('#posts-list').append(postElement);
                            
                            // Update last timestamp
                            if (post.timestamp > lastTimestamp) {
                                lastTimestamp = post.timestamp;
                            }
                        });
                    } else {
                        showMessage(response.message, false);
                    }
                },
                error: function() {
                    showMessage('Error loading posts', false);
                }
            });
        }
        
        // Check for new posts
        function checkForNewPosts() {
            if (lastTimestamp === 0) return;
            
            $.ajax({
                url: 'get_posts.php',
                type: 'GET',
                data: {
                    last_timestamp: lastTimestamp
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success && response.data.count > 0) {
                        // New posts found, reload all posts
                        loadPosts();
                    }
                }
            });
        }
        
        // Event listeners
        $(document).ready(function() {
            // Check if user is already logged in
            checkAuth();
            
            // Register form submission
            $('#register-form').on('submit', function(e) {
                e.preventDefault();
                const username = $('#register-username').val();
                const password = $('#register-password').val();
                registerUser(username, password);
            });
            
            // Login form submission
            $('#login-form').on('submit', function(e) {
                e.preventDefault();
                const username = $('#login-username').val();
                const password = $('#login-password').val();
                loginUser(username, password);
            });
            
            // Logout button
            $('#logout-btn').on('click', function() {
                logoutUser();
            });
            
            // New post submission
            $('#new-post-form').on('submit', function(e) {
                e.preventDefault();
                const title = $('#post-title').val();
                const content = $('#post-content').val();
                createPost(title, content);
            });
            
            // Clear error when user starts typing again
            $('input, textarea').on('input', function() {
                $(this).removeClass('error-field');
                const errorId = $(this).attr('id') + '-error';
                $('#' + errorId).hide();
            });
        });
    </script>
</body>
</html>